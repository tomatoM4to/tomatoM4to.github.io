# 회복(recovery)
지금 예기하는 화복도 있는데 제일 마지막에 복원이란 파트가 있음, 이것도 회복이라 할수 있음, 잠시 예기해주면 디스크가 깨지는 경우를 예기함

지금 예기하는건 전원같은게 나가가지고 트랜잭션이 깨지는 경우를 예기함

즉 DB에 장애가 발생해도 일관성을 유지하는것이 recovery 임

트랜잭션은 기본적으로 All or Not 임

이때 중간에 오류가 생겨서 뒤로 돌아가려 할 상황이 발생하면뒤로 돌아가야 함,이때 로그파일을 씀

일단 DB 시스템에서 발생하 수 있는 장애 유형부터 알아보자

## 장애 유형
완벽히 나누어 지는건 아니고 이런걸 생각할 수 있음

* 시스템 충돌: HW, SW의 오류로 인해 RAM의 정보다 손실되어, RAM에 상주해 있던 프로그램과 데이터가 손실, 가장 흔한 상태임
* 미디어 장애: 이것도 일종의 HW의 장애일수도 있음
* 완벽한 SW란 있을순 없으니... os에도 에러가 발생할 수 있음
* 자연재해
* 부주의 혹은 태업: 사람이 실수로 컴퓨터 끌수도 있음

## 다이어그램

## 로그파일
트랜잭션이 반영한 모든 데이터의 **변경 사항**을 DB에 기록하기 변경하기 **전에** 미리 기록해두는 별도의 데이터 베이스, 읽는건 상관없음

기록한 후에 기록하지 않음, 그리고 이또한 DB임

근데 DB도 디스크에저장돼고 로그도 디스크에 저장돼는건 뭔가 이상함, 디스크 뽀개지면 끝이자나

로그파일은 별도의 저장장치, 보다 안전힌 디스크에 저장됨, 물론 실습으로 쓰는 개인 컴퓨터로 쓰면 같은 디스크에 저장돼고, 은행 같은곳에선 이렇게 함 사실 대부분 하나의 디스크로 처리하긴 함

### 로그의 구조
인서트라면 어떤 테이블에 어떤 튜플이 추가돼었단 정보가 있겠지

## 로그 파일을 이용한 회복
UPDATE 는 사실 read 와 write의 조합이기 때문에 엄밀힌 틀렸지만 편의상 이렇게 보겠다.

TODO: 67page

핵심은 read 될때가 아닌 wriet 돼기 전 로그에 적힌다는 거다.


TODO: 69page

이때 특정 로그번호에서 죽었다 가정 하자 이때 T2 중간에 꺼졌다면 10번의 COMMIT 기록은 없을거다. COMMIT이 적혀있어도 사실 COMMIT이 돼있다고 할수도 없다.

이제 다시 컴퓨터를 켜서 ㄱ동되면 DBMS는 로그파일을 먼저 살펴본다....

이때 트랜잭션을 복구하는 방법은 2가지다,

### REDO
이전에 COMMIT이 돼 있어도 또 적는다. COMMIT이 돼 있다면 뒤에있는 값(여기선 10이 더해진 값)으로 다시 적는다. 확인사살을 한다 생각해도 괜찮다.

### UNDO
COMMIT이 없는 경우다. 이때는  NOTHING로 만들어야 한다. 위 예제에선 7번까지 적혀있는 경우다. 이땐 REDO가 불가능하니 NOTHING로 만들어 버린다. 이때 방법은 OLD값으로 써주면 돼니 쉽다.


## 커밋의 타이밍

이전에 커밋을 해도 disk에 안써질수 있다 했다. 성능 이슈 때문에.. 근데 이때 커밋을 언제 할지에 따라서 로그를 쓰는 방법도 달라진다.

이를 구분해 즉시 갱신 방법과 지연 갱신 방법 두가지로 나뉜다.

근데 이때 디스크에 저장 한다음  COMMIT 하는 방법을 사용한다 해도 사실 disk에 넣는건 OS의 역할인데.. 이 OS도 디스크에 바로 작성하는게 아니라 이 경우에도 COMMIT 시 반드시 disk에 있다 생각할순 없다. 참.. 뭣같네

엄밀히 따지면 즉시 갱신 기법이 맞지만, 성능상의 이유같은 여러 이유로 지연 갱신 방법이 스텐다드 방식으로 통한다.

### 커밋 타이밍에 따른 예제
TODO: 71 페이지 테이블 작성, 해당 예제의 로그는 68페이지에 있음

테이블을 보시면 감이 오겠지만 의외로 지연 갱신 방법이 더 단순합니다.

## 문제점
DBMS 에 로그가 어마나  많을까요? 대규모 서비스라면 하루만  로그를 기록해도 양이 너무 많아지고 복구도 사실상 불가능해 집니다. 그래서 보통 몇십분 단위로 로깅을 합니다. 이를 체크포인트라 합니다.

체크포인트 시점엔 COMMIT과 상과없이 버퍼에 있는 내용을 하드디스크에 저장을 합니다. 로그파일이니 하드에 저장하기전 로그에 적은다음 COMMIT이든 말든 일단 디스크에 저장하게 됩니다.

### 체크포인틀를 이용한 회복
회복이 더 쉬워짐

TODO: 76 페이지 테이블

9번의 체크포인트 시점에서 T1 커밋은 신경쓰지 않음, 리커버리에 아예 빼버림? 효휼성 업

그외 나머진 이전에 햇던것과 똑같음

체크포인는 주기적으로 딱딱 실행되는거니 언제 올지는 모름
